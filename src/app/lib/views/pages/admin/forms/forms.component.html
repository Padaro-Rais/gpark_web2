<div class="dashboard-preview">
  <div class="app-page-header">
    <h2>Gestionnaire des formulaires</h2>
    <div class="app-intro">
      Liste des formulaires créer pour la gestion des différentes modules du
      système.
    </div>
  </div>
  <ng-container *ngIf="state$ | async as vm">
    <clr-datagrid
      #clrDataGrid
      (clrDgRefresh)="onDgRefresh($event)"
      [clrDgLoading]="vm?.performingAction"
      class="datagrid-compact"
      [(clrDgSelected)]="selectedValues"
    >
      <clr-dg-action-bar>
        <drewlabs-datgrid-header
          [refreshButtonDisabled]="vm?.performingAction"
          [createButtonDisabled]="vm?.performingAction"
          [showCreate]="isSelectionEnabled"
          (createEvent)="onCreateButtonClicked()"
          (refreshEvent)="onDgHeaderRefresh()"
        >
          <!-- Add a drop down content that show the rest of actions-->
          <clr-dropdown *ngIf="showExportDropdown">
            <button
              type="button"
              [disabled]="vm?.performingAction || selectedValues?.length === 0"
              class="btn btn-sm btn-secondary"
              clrDropdownTrigger
            >
              Exporter
              <clr-icon shape="caret down"></clr-icon>
            </button>
            <clr-dropdown-menu clrPosition="bottom-left" *clrIfOpen>
              <button
                type="button"
                [disabled]="exportButtonDisabled"
                (click)="onExportToExcelEvent()"
                clrDropdownItem
              >
                {{ 'Exporter en JSON' | translate | uppercase }}
              </button>
            </clr-dropdown-menu>
          </clr-dropdown>
          <!--\ Add a drop down content that show the rest of actions-->
        </drewlabs-datgrid-header>
      </clr-dg-action-bar>
      <clr-dg-column>ID</clr-dg-column>
      <clr-dg-column [clrDgField]="'id'">
        {{ 'Contexte' | uppercase }}
      </clr-dg-column>
      <clr-dg-column [clrDgField]="'title'">
        {{ 'Titre' | uppercase }}
      </clr-dg-column>
      <clr-dg-column [clrDgField]="'endpoint_url'">
        {{ 'Lien URL' | uppercase }}
      </clr-dg-column>
      <clr-dg-column [clrDgField]="'description'">
        {{ 'Description' | uppercase }}
      </clr-dg-column>
      <!-- FORM CONTROLS ROW -->
      <clr-dg-row *ngIf="!isSelectionEnabled">
        <clr-dg-action-overflow>
          <button class="action-item" (click)="onCancelFormAction()">
            ANNULER
          </button>
        </clr-dg-action-overflow>
        <ng-container *ngIf="formState">
          <clr-dg-cell><!-- Button--></clr-dg-cell>
          <ng-container *ngFor="let name of controlNames; let last = last">
            <clr-dg-cell>
              <app-dynamic-inputs
                [inline]="true"
                [showLabelAndDescription]="false"
                *ngIf="(formState?.formgroup?.controls)[name]"
                [control]="formState?.formgroup?.get(name)"
                [inputConfig]="(formState?.controlConfigs)[name]"
              ></app-dynamic-inputs>
              <button
                (click)="
                  createFormComponent.handleSubmitButtonClick(
                    formState?.url,
                    formState?.formgroup
                  )
                "
                *ngIf="last"
                class="btn submit-btn"
              >
                OK
              </button>
            </clr-dg-cell>
          </ng-container>
        </ng-container>
      </clr-dg-row>
      <!--\ FORM CONTROL ROW -->
      <clr-dg-row *ngFor="let item of vm?.dataSource.data" [clrDgItem]="item">
        <clr-dg-action-overflow>
          <button class="action-item" (click)="navigateToEditView(item)">
            ÉDITER
          </button>
          <button class="action-item" (click)="showCreateView(item)">
            NOUVEAU CHAMP
          </button>
        </clr-dg-action-overflow>
        <clr-dg-cell>{{ item.id }}</clr-dg-cell>
        <clr-dg-cell>{{ item?.appcontext }}</clr-dg-cell>
        <clr-dg-cell>{{ item?.title | uppercase }}</clr-dg-cell>
        <clr-dg-cell>{{ item.url }}</clr-dg-cell>
        <clr-dg-cell>{{ item?.description | uppercase }}</clr-dg-cell>
      </clr-dg-row>
      <!--- DETAILS VIEW -->
      <ng-template clrIfDetail let-detail (clrIfDetailChange)="onDetailsStateChange($event)">
        <clr-dg-detail>
          <clr-dg-detail-header>{{ detail.title }}</clr-dg-detail-header>
          <clr-dg-detail-body>
            <app-form-controls
              [form]="detail"
              (showCreatePreviewChange)="createPreviewViewIndex = undefined"
              [showCreatePreview]="createPreviewViewIndex === detail?.id"
              [(showCreatePreview)]="showCreatePreview"
            ></app-form-controls>
          </clr-dg-detail-body>
        </clr-dg-detail>
      </ng-template>
      <!--\ DETAILS VIEW  -->
      <clr-dg-footer>
        {{ vm?.dataSource?.total }} Formulaires
        <clr-dg-pagination
          [clrDgPageSize]="10"
          #pagination
          [clrDgTotalItems]="vm?.dataSource?.total"
        >
          <clr-dg-page-size
            [clrPageSizeOptions]="[10, 20, 30]"
          ></clr-dg-page-size>
        </clr-dg-pagination>
      </clr-dg-footer>
    </clr-datagrid>
  </ng-container>
</div>
<!-- Component binding and Loading forms-->
<app-create-form
  #createFormComponent
  [selected]="selected"
  [id]="formID"
  (stateChange)="onCreateFormStateChange($event)"
  (actionCompleted)="resetFormState()"
></app-create-form>
<!--\ Component binding and Loading forms-->
